# BudgetModel

Represents a budget period with a total amount and date range in Centabit.

## Overview

`BudgetModel` is an immutable domain model representing a budget period. A budget defines a spending limit for a specific time period (e.g., monthly, quarterly). Multiple allocations distribute the budget across categories.

**Location:** `lib/data/models/budget_model.dart`

## Properties

### Core Fields

#### `id` (String, required)
Unique identifier (UUID v4).

Auto-generated by `.create()` factory. Used for lookups and allocation links.

```dart
final id = budget.id; // "b8f3d7e4-1a2b-4c5d-8e9f-0a1b2c3d4e5f"
```

#### `name` (String, required)
Budget display name.

**Best practices:**
- Use month names: `"December 2025"`, `"January 2026"`
- Use quarters: `"Q1 2026"`, `"Q4 2025"`
- Be descriptive: `"Holiday Season 2025"`, `"Summer Budget"`

```dart
final name = budget.name; // "December 2025"
```

#### `amount` (double, required)
Total budget amount.

This is the total available funds for the period. The sum of allocations may be less than this amount (unallocated funds).

```dart
final amount = budget.amount; // 2000.00
```

**Note:** This is the total budget pool, not the sum of allocations. Users can allocate less than the total to leave flexibility.

#### `startDate` (DateTime, required)
Budget period start date (inclusive).

**Best practices:**
- Set to beginning of period: `DateTime(2025, 12, 1)` for December
- Use midnight time: `00:00:00`
- Include in period calculations (inclusive range)

```dart
final start = budget.startDate; // 2025-12-01 00:00:00
```

Used for:
- Filtering transactions by date range
- BAR calculation (elapsed days)
- Budget activation status

#### `endDate` (DateTime, required)
Budget period end date (inclusive).

**Best practices:**
- Set to end of period: `DateTime(2025, 12, 31, 23, 59, 59)`
- Or start of next day: `DateTime(2026, 1, 1)`
- Include in period calculations (inclusive range)

```dart
final end = budget.endDate; // 2025-12-31 23:59:59
```

Used for:
- Filtering transactions by date range
- BAR calculation (total days)
- Budget activation status

### Timestamp Fields

#### `createdAt` (DateTime, required)
Timestamp when budget was created.

Auto-generated by `.create()` factory. Immutable after creation.

#### `updatedAt` (DateTime, required)
Timestamp when budget was last modified.

Auto-generated by `.create()`. Updated automatically by `.withUpdatedTimestamp()`.

## Factory Constructors

### `BudgetModel.create()`

Creates a new budget with auto-generated ID and timestamps.

**Signature:**
```dart
factory BudgetModel.create({
  required String name,
  required double amount,
  required DateTime startDate,
  required DateTime endDate,
})
```

**Parameters:**
- `name` - Budget display name (e.g., "December 2025")
- `amount` - Total budget amount (must be positive)
- `startDate` - Period start (inclusive)
- `endDate` - Period end (inclusive)

**Auto-generated:**
- `id` - New UUID v4
- `createdAt` - Current timestamp
- `updatedAt` - Current timestamp

**Example:**
```dart
// Monthly budget
final monthly = BudgetModel.create(
  name: 'December 2025',
  amount: 2000.00,
  startDate: DateTime(2025, 12, 1),
  endDate: DateTime(2025, 12, 31, 23, 59, 59),
);

// Quarterly budget
final quarterly = BudgetModel.create(
  name: 'Q1 2026',
  amount: 6000.00,
  startDate: DateTime(2026, 1, 1),
  endDate: DateTime(2026, 3, 31, 23, 59, 59),
);

// Custom period
final custom = BudgetModel.create(
  name: 'Holiday Season 2025',
  amount: 3000.00,
  startDate: DateTime(2025, 11, 20),
  endDate: DateTime(2025, 12, 31, 23, 59, 59),
);
```

### `BudgetModel.fromJson()`

Deserializes budget from JSON map.

**Signature:**
```dart
factory BudgetModel.fromJson(Map<String, dynamic> json)
```

**Example:**
```dart
final json = {
  'id': 'b8f3d7e4-1a2b-4c5d-8e9f-0a1b2c3d4e5f',
  'name': 'December 2025',
  'amount': 2000.00,
  'startDate': '2025-12-01T00:00:00.000Z',
  'endDate': '2025-12-31T23:59:59.999Z',
  'createdAt': '2025-11-28T10:00:00.000Z',
  'updatedAt': '2025-11-28T10:00:00.000Z',
};

final budget = BudgetModel.fromJson(json);
```

## Methods

### `toJson()`

Serializes budget to JSON map.

**Signature:**
```dart
Map<String, dynamic> toJson()
```

**Example:**
```dart
final json = budget.toJson();
// {
//   'id': '...',
//   'name': 'December 2025',
//   'amount': 2000.00,
//   ...
// }
```

### `copyWith()`

Creates a copy with modified fields (Freezed-generated).

**Signature:**
```dart
BudgetModel copyWith({
  String? id,
  String? name,
  double? amount,
  DateTime? startDate,
  DateTime? endDate,
  DateTime? createdAt,
  DateTime? updatedAt,
})
```

**Example:**
```dart
// Update amount
final updated = budget.copyWith(amount: 2500.00);

// Extend end date
final extended = budget.copyWith(
  endDate: DateTime(2026, 1, 5, 23, 59, 59),
);

// Rename budget
final renamed = budget.copyWith(name: 'December 2025 - Extended');
```

## Extension Methods

### `isActive()`

Checks if this budget is currently active.

**Signature:**
```dart
bool isActive()
```

**Returns:** `true` if current date/time falls within budget period (inclusive).

**Algorithm:**
```dart
final now = DateTime.now();
return !now.isBefore(startDate) && !now.isAfter(endDate);
```

**Example:**
```dart
// Today: 2025-12-15
final budget = BudgetModel.create(
  name: 'December 2025',
  amount: 2000.00,
  startDate: DateTime(2025, 12, 1),
  endDate: DateTime(2025, 12, 31, 23, 59, 59),
);

print(budget.isActive()); // true

// Check if budget should be shown in "Active Budgets" section
if (budget.isActive()) {
  // Display in active list
} else {
  // Archive or hide
}
```

### `totalDays()`

Calculates the total number of days in budget period.

**Signature:**
```dart
int totalDays()
```

**Returns:** Total days including both start and end dates (+1).

**Formula:**
```dart
endDate.difference(startDate).inDays + 1
```

**Example:**
```dart
final budget = BudgetModel.create(
  name: 'December 2025',
  amount: 2000.00,
  startDate: DateTime(2025, 12, 1),
  endDate: DateTime(2025, 12, 31),
);

print(budget.totalDays()); // 31 days

// Use in BAR calculation
final timeRatio = elapsedDays / budget.totalDays();
```

### `elapsedDays()`

Calculates the number of elapsed days in budget period.

**Signature:**
```dart
int elapsedDays()
```

**Returns:**
- `0` if current date is before budget start
- `totalDays()` if current date is after budget end
- Actual elapsed days (+1 for inclusive) otherwise

**Algorithm:**
```dart
final now = DateTime.now();
if (now.isBefore(startDate)) {
  return 0;
} else if (now.isAfter(endDate)) {
  return totalDays();
} else {
  return now.difference(startDate).inDays + 1;
}
```

**Example:**
```dart
// Budget: Dec 1-31, 2025
// Today: Dec 15, 2025
final budget = BudgetModel.create(
  name: 'December 2025',
  amount: 2000.00,
  startDate: DateTime(2025, 12, 1),
  endDate: DateTime(2025, 12, 31),
);

print(budget.elapsedDays()); // 15 days
print(budget.totalDays());   // 31 days

// Used in BAR calculation
final timeProgress = budget.elapsedDays() / budget.totalDays();
print('Time progress: ${(timeProgress * 100).toStringAsFixed(1)}%');
// Output: Time progress: 48.4%
```

### `withUpdatedTimestamp()`

Returns a copy with updated timestamp.

**Signature:**
```dart
BudgetModel withUpdatedTimestamp()
```

**Returns:** New instance with `updatedAt` set to `DateTime.now()`.

**Example:**
```dart
// Update budget and refresh timestamp
final updated = budget
  .withUpdatedTimestamp()
  .copyWith(amount: 2500.00);

// Equivalent to:
final updated = budget.copyWith(
  amount: 2500.00,
  updatedAt: DateTime.now(),
);
```

**Usage in Repository:**
```dart
// Repository automatically updates timestamp on modifications
Future<void> updateBudget(BudgetModel model) async {
  final updatedModel = model.withUpdatedTimestamp();
  await _localSource.updateBudget(_mapToDbModel(updatedModel));
}
```

## Usage Examples

### Create Monthly Budget

```dart
import 'package:centabit/data/models/budget_model.dart';
import 'package:centabit/data/repositories/budget_repository.dart';

// Create budget for current month
final now = DateTime.now();
final startDate = DateTime(now.year, now.month, 1);
final endDate = DateTime(now.year, now.month + 1, 0, 23, 59, 59);

final budget = BudgetModel.create(
  name: '${_getMonthName(now.month)} ${now.year}',
  amount: 2000.00,
  startDate: startDate,
  endDate: endDate,
);

// Save via repository
final repository = getIt<BudgetRepository>();
await repository.createBudget(budget);
```

### Check Budget Status

```dart
// Get all active budgets
final activeBudgets = repository.getActiveBudgets();

print('Active budgets:');
for (final budget in activeBudgets) {
  final progress = budget.elapsedDays() / budget.totalDays();
  print('${budget.name}: ${(progress * 100).toInt()}% complete');
}

// Example output:
// Active budgets:
// December 2025: 48% complete
```

### Calculate BAR (Budget Adherence Ratio)

```dart
// Get budget and spending data
final budget = await repository.getBudgetById(budgetId);
final allocations = allocationRepository
  .getAllocationsForBudget(budgetId);

final totalBudget = allocations.fold<double>(
  0,
  (sum, a) => sum + a.amount,
);

final transactions = transactionRepository.transactions.where((tx) {
  return tx.budgetId == budgetId &&
         tx.type == TransactionType.debit;
}).toList();

final totalSpent = transactions.fold<double>(
  0,
  (sum, tx) => sum + tx.amount,
);

// Calculate BAR
final timeRatio = budget.elapsedDays() / budget.totalDays();
final spendRatio = totalSpent / totalBudget;
final bar = spendRatio / timeRatio;

print('BAR: ${bar.toStringAsFixed(2)}');
// BAR: 0.85 (spending slower than time - good!)
// BAR: 1.15 (spending faster than time - warning!)
```

### Extend Budget Period

```dart
// Extend budget by 5 days
final extended = budget
  .withUpdatedTimestamp()
  .copyWith(
    endDate: budget.endDate.add(Duration(days: 5)),
  );

await repository.updateBudget(extended);
```

### Create Budget with Allocations

```dart
// 1. Create budget
final budget = BudgetModel.create(
  name: 'December 2025',
  amount: 2000.00,
  startDate: DateTime(2025, 12, 1),
  endDate: DateTime(2025, 12, 31, 23, 59, 59),
);
await budgetRepository.createBudget(budget);

// 2. Create allocations
final allocations = [
  AllocationModel.create(
    budgetId: budget.id,
    categoryId: groceryCategoryId,
    amount: 500.00,
  ),
  AllocationModel.create(
    budgetId: budget.id,
    categoryId: diningCategoryId,
    amount: 300.00,
  ),
  AllocationModel.create(
    budgetId: budget.id,
    categoryId: transportCategoryId,
    amount: 200.00,
  ),
];

for (final allocation in allocations) {
  await allocationRepository.createAllocation(allocation);
}

// Total allocated: $1000 (budget has $1000 unallocated)
```

## Relationships

### One-to-Many with Allocations

```
Budget (1) ──< (N) Allocations
```

A budget has multiple allocations (one per category). Each allocation references the budget via `budgetId`.

**Access:**
```dart
final allocations = allocationRepository
  .getAllocationsForBudget(budget.id);

final totalAllocated = allocations.fold<double>(
  0,
  (sum, a) => sum + a.amount,
);

final unallocated = budget.amount - totalAllocated;
print('Unallocated: \$${unallocated.toStringAsFixed(2)}');
```

### One-to-Many with Transactions

```
Budget (1) ──< (N) Transactions
```

A budget has multiple transactions (spending entries). Transactions link to budgets via `budgetId`.

**Filtering:**
```dart
final budgetTransactions = transactionRepository.transactions
  .where((tx) => tx.budgetId == budget.id)
  .toList();

print('${budgetTransactions.length} transactions in ${budget.name}');
```

## BAR Calculation

Budget Adherence Ratio (BAR) measures spending health by comparing spending rate to time progression.

### Formula

```
BAR = (totalSpent / totalBudget) / (elapsedDays / totalDays)
```

### Interpretation

- **BAR < 0.85:** Well under budget (green)
- **BAR 0.85-0.95:** Slightly under budget (green)
- **BAR 0.95-1.05:** Right on track (blue)
- **BAR 1.05-1.15:** Slightly over budget (yellow)
- **BAR > 1.15:** Significantly over budget (red)

### Example Calculation

```dart
// Budget: $1500, Period: 30 days, Elapsed: 15 days
final budget = BudgetModel.create(
  name: 'Test Budget',
  amount: 1500.00,
  startDate: DateTime(2025, 12, 1),
  endDate: DateTime(2025, 12, 31),
);

final totalBudget = 1500.00;
final totalSpent = 800.00;
final elapsedDays = 15;
final totalDays = 31;

// Time ratio: 15/31 = 0.484 (48.4%)
final timeRatio = elapsedDays / totalDays;

// Spend ratio: 800/1500 = 0.533 (53.3%)
final spendRatio = totalSpent / totalBudget;

// BAR: 0.533 / 0.484 = 1.10 (slightly over pace)
final bar = spendRatio / timeRatio;

print('BAR: ${bar.toStringAsFixed(2)}'); // BAR: 1.10
```

## Best Practices

### Use Descriptive Names
Make budget names clear and date-specific:

```dart
// ✅ Good - clear period identification
BudgetModel.create(name: 'December 2025', ...)
BudgetModel.create(name: 'Q1 2026', ...)
BudgetModel.create(name: 'Holiday Season 2025', ...)

// ❌ Bad - vague or unclear
BudgetModel.create(name: 'Budget 1', ...)
BudgetModel.create(name: 'Main', ...)
```

### Set Proper Date Boundaries
Use full day ranges for accurate calculations:

```dart
// ✅ Good - full month coverage
BudgetModel.create(
  name: 'December 2025',
  startDate: DateTime(2025, 12, 1, 0, 0, 0),
  endDate: DateTime(2025, 12, 31, 23, 59, 59),
  ...
)

// ❌ Bad - missing end-of-day time
BudgetModel.create(
  name: 'December 2025',
  startDate: DateTime(2025, 12, 1),
  endDate: DateTime(2025, 12, 31), // Missing time!
  ...
)
```

### Allow Unallocated Funds
Budget amount can exceed sum of allocations:

```dart
// ✅ Good - budget provides flexibility
final budget = BudgetModel.create(
  name: 'December 2025',
  amount: 2000.00, // Total available
  ...
);

// Allocate only $1500, leaving $500 buffer
final allocations = [
  AllocationModel.create(..., amount: 500.00),
  AllocationModel.create(..., amount: 500.00),
  AllocationModel.create(..., amount: 500.00),
];
```

## See Also

- [AllocationModel](./allocation-model.md) - Budget category allocations
- [TransactionModel](./transaction-model.md) - Transaction entity
- [BudgetRepository](../repositories/budget-repository.md) - Data access
- [DashboardCubit](../cubits/dashboard-cubit.md) - BAR calculations
